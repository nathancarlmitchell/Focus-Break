<!--
    Ideas:

    myInterval functions can be condensed to a single function and passed variables for color, x, y

    OPTIONS
    - Create a button that makes a new page
    - set options and store as a cookie?

    Levels 5 - 10 feel very same
    - updated, test
    - Offset the x position by random ammount to prevent objects in line

    Level 10: bonus score
    - Add bonus to total score
    - slowly increase object spawn as level progresses

    Stop timer if paused

    Forced hyper

    Destroy all objets on break?  or within x of current position

    Powerup / life limit

    To create a scalable window
    Isolate drawing to a separate function
    multiple or divide by a factor depending on screen resolution
    Change size and position

    MOBILE TOUCH

    MOVETO function?
    - smooth mouse movements, when unpause to prevent jumping
-->

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF8"  />
</head>
<body onload="onLoad()" onresize="windowResize()" onmousemove="mouseMove()" oncontextmenu="return false;">
    <div id="audio">
        <!--    <iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/users/5333822&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
        iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/531718938&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
        -->
        <iframe src="music\fx 11.wav" allow="autoplay" style="display:none" id="iframeAudio"></iframe>
        <audio id="audio01" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 01 Before U Go.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio02" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 02 Reflex.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio03" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 03 Blood (feat. Fifty Grand).mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio04" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 04 Undefined.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio05" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 05 Lay.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio06" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 06 Kitty Kat.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio07" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 07 Too Late.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio08" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 08 Midnight (Cavalier Version).mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio09" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 09 Commas.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio10" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 10 Gone.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio11" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 11 Love U.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="bombSFX" style="visibility:hidden">
            <source src="music\BOMB_SIREN-BOMB_SIREN-247265934.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx11" style="visibility:hidden">
            <source src="music\fx 11.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx14" style="visibility:hidden">
            <source src="music\fx 14.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="danger" style="visibility:hidden">
            <source src="music\72.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="menusound2" style="visibility:hidden">
            <source src="music\Menu Sounds_2.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx_powerUp" style="visibility:hidden">
            <source src="music\powerUp.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx_pickupCoin" style="visibility:hidden">
            <source src="music\pickupCoin.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx_click" style="visibility:hidden">
            <source src="music\click.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx_blipSelect" style="visibility:hidden">
            <source src="music\blipSelect.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
    </div>
<script>

// initialize audio
const aud_01 = document.getElementById("audio01");
const aud_02 = document.getElementById("audio02");
const aud_03 = document.getElementById("audio03");
const aud_04 = document.getElementById("audio04");
const aud_05 = document.getElementById("audio05");
const aud_06 = document.getElementById("audio06");
const aud_07 = document.getElementById("audio07");
const aud_08 = document.getElementById("audio08");
const aud_09 = document.getElementById("audio09");
const aud_10 = document.getElementById("audio10");
const aud_11 = document.getElementById("audio11");
const all_songs = [aud_01, aud_02, aud_03, aud_04, aud_05, aud_06, aud_07, aud_08, aud_09, aud_10, aud_11];
const aud_bomb = document.getElementById("bombSFX");
const aud_menuSound = document.getElementById("menusound2");
const aud_death = document.getElementById("fx14");
const aud_danger = document.getElementById("danger");
const aud_powerUp = document.getElementById("fx_powerUp");
const aud_pickupCoin = document.getElementById("fx_pickupCoin");
const aud_click = document.getElementById("fx_click");
const aud_blipSelect = document.getElementById("fx_blipSelect");
aud_danger.volume = 0.05;
aud_bomb.volume = 0.3;
aud_death.volume = 0.15;
aud_powerUp.volume = 0.1;
aud_pickupCoin.volume = 0.1;
aud_click.volume = 0.1;
aud_blipSelect.volume = 0.1;
var musicVolume = 0.2;


// bounding variables used on start screen
var bounds_click_to_start = false;
var bounds_space_to_break = false;
var bounds_shift_to_focus = false;
var bounds_click_to_warp  = false;

// intervals used for start screen animation
const myInterval1 = setInterval(updateSloganText, 3000);
const myInterval2 = setInterval(focus_break_colors, 100);
const myInterval3 = setInterval(click_to_start_colors, 50);
const myInterval4 = setInterval(space_to_break_colors, 100);
const myInterval5 = setInterval(shift_to_focus_colors, 100);
const myInterval6 = setInterval(click_to_warp_colors, 100);

// initialize objects
var objects_slow = [];
var objects_medium = [];
var objects_fast = [];
var objects_hyper = [];
var objects_powerup_break = [];
var objects_powerup_score = [];

// game play variables
var x = window.innerWidth;
var y = window.innerHeight;
var startDate;
var gamePiece;
var gamePieceColor = "blue";
var sloganText = "";
var deathSlogan = "";
var sloganY = 120;
var sloganX = 100;

var invincible = false;
var gameStart = false;
var alive = false;
var focused = false;
var firstRun = true;
var pause = false;

var score = 0;
var scoreLimit = 1000;
var powerupScoreBonus = 50;
var scorePenalty = 250; // point deduction for break
var deaths = 0;
var invincibleTime = 0;
var invincibleTimeMax = 200;
var perfectClear = 0;
var level = 1;
var speed = 1;
var speed_slow = 0.25;
var speed_fast = 2;


function loadAudio() { 
    setAudioVolume(all_songs, musicVolume);
    aud_01.onended = function() { aud_02.play(); };
    aud_02.onended = function() { aud_03.play(); };
    aud_03.onended = function() { aud_04.play(); };
    aud_04.onended = function() { aud_05.play(); };
    aud_05.onended = function() { aud_06.play(); };
    aud_06.onended = function() { aud_07.play(); };
    aud_07.onended = function() { aud_08.play(); };
    aud_08.onended = function() { aud_09.play(); };
    aud_09.onended = function() { aud_10.play(); };
    aud_10.onended = function() { aud_11.play(); };
    aud_11.onended = function() { aud_01.play(); };
    if (firstRun){
        aud_01.play();
    }
}

function setAudioSpeed(audio, speed) { // set audio playback rate for all songs
    for (i = 0; i < audio.length; i += 1) {
        audio[i].playbackRate = speed;
    }
}

function setAudioVolume(audio, volume) { // set audio volume for all songs
    for (i = 0; i < audio.length; i += 1) {
        audio[i].volume = volume;
    }   
}

function mouseMove() { // detect mouse on start screen
    var mouseX = event.clientX - 8;
    var mouseY = event.clientY - 8;
    if (firstRun) {
        if(mouseX > (x / 2) - 410 && mouseX < (x / 2) - 190 && mouseY > (y / 2) - 32 && mouseY < (y / 2) + 14) { // CLICK TO START
            bounds_click_to_start = true;
        }
        else if(mouseX > (x / 2) && mouseX < (x / 2) + 272 && mouseY > (y / 2) && mouseY < (y / 2) + 40) { // SPACE TO BREAK
            bounds_space_to_break = true;
        }
        else if(mouseX > (x / 2) && mouseX < (x / 2) + 272 && mouseY > (y / 2) + 60 && mouseY < (y / 2) + 100) { // SHIFT TO FOCUS
            bounds_shift_to_focus = true;
        }
        else if(mouseX > (x / 2) && mouseX < (x / 2) + 272 && mouseY > (y / 2) + 120 && mouseY < (y / 2) + 160) { // CLICK TO WARP
            bounds_click_to_warp = true;
        } else {
            if (bounds_click_to_start || bounds_space_to_break || bounds_shift_to_focus || bounds_click_to_warp) {
                drawStartScreen();       
                //bounds_click_to_start = bounds_shift_to_focus = bounds_space_to_break = bounds_click_to_warp = false;
                bounds_click_to_start = false;
                bounds_shift_to_focus = false;
                bounds_space_to_break = false;
                bounds_click_to_warp  = false;
            }
        }
    }
}

function focus_break_colors(){ // Flashing colors on start screen
    ctx = gameArea.canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.font = "80px Arial";
    ctx.fillStyle = getRandomColor();
    for (count = 127; count < 130; count++){ // Bold effect
        ctx.fillText("FOCUS BREAK", count, count+80);
        ctx.fillText("焦点を絞る", count+100, count+180);
    }
    ctx.fillStyle = "#ff00ff";
    ctx.fillText("FOCUS BREAK", count, count+80);
    ctx.fillText("焦点を絞る", count+100, count+180);
}

function click_to_start_colors(){ // Flashing colors on start screen
    if (bounds_click_to_start) {
        ctx.globalAlpha = 0.35;
        ctx.fillStyle = getRandomColorGold();
        i_x = getRandomInteger(-1, 1);
        i_y = getRandomInteger(-1, 1);
        ctx.fillRect((x / 2)-410+i_x,(y / 2) - 32+i_y, (220)+i_x, 44+i_y);
        ctx.font = "25px Arial";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "black";
        ctx.fillText("CLICK TO START", (x / 2)-400, (y / 2));
    }
}

function space_to_break_colors(){ // Flashing colors on start screen
    if (bounds_space_to_break) {
        ctx.fillStyle = "#000000";
        ctx.fillRect(x/2, y/2, 272, 40);
        ctx.font = "40px Impact";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = getRandomColor();
        ctx.fillText("Space to Break", x / 2 , y / 2 +38);
        ctx.globalAlpha = 1.0;
    }
}

function shift_to_focus_colors(){ // Flashing colors on start screen
    if (bounds_shift_to_focus) {
        ctx.fillStyle = "#000000";
        ctx.fillRect(x/2, y/2+60, 272, 40);
        ctx.font = "40px Impact";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = getRandomColor();
        ctx.fillText("Shift to Focus", x / 2, y / 2 + 100);
        ctx.globalAlpha = 1.0;
    }
}

function click_to_warp_colors(){ // Flashing colors on start screen
    if (bounds_click_to_warp) {
        ctx.fillStyle = "#000000";
        ctx.fillRect(x/2, y/2+120, 272, 40);
        ctx.font = "40px Impact";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = getRandomColor();
        ctx.fillText("Click to warp", x / 2, y / 2 + 160);
        ctx.globalAlpha = 1.0;
    }
}

function onLoad() {
    gameArea.load();
    unloadScrollBars();
    updateSloganText();
    drawStartScreen();
}

function updateSloganText() {
    var slogan = Math.floor(Math.random() * 18) + 1;
    switch (slogan) { // slogans
        case 1:sloganText = "TOO HARD";break;
        case 2:sloganText = "Now in Color!";break;
        case 3:sloganText = "Vegan!";break;
        case 4:sloganText = "Siezure inducing!";break;
        case 5:sloganText = "Advanced!";break;
        case 6:sloganText = "Fresh!";break;
        case 7:sloganText = "Spicy!";break;
        case 8:sloganText = "Gotta Go Fast!";break;
        case 9:sloganText = "Classic";break;
        case 10:sloganText = "Coming Soon!";break;
        case 11:sloganText = "4K 1080p";break;
        case 12:sloganText = "Lite";break;
        case 13:sloganText = "今は日本語です！";break;
        case 14:sloganText = "Version 2";break;
        case 15:sloganText = "Bug Free!";break;
        case 16:sloganText = "Not Lame!";break;
        case 17:sloganText = "...";break;
        case 18:sloganText = "ULTRA";break;
        case 19:sloganText = "";break;
    }
    drawStartScreen();
}

function windowResize() {
    x = window.innerWidth;
    y = window.innerHeight;
    gameArea.load();
    if (!gameStart) {
        drawStartScreen();
    }
}

function drawStartScreen() { // draw the start screen
    ctx = gameArea.canvas.getContext("2d");
    
    // clear screen
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, x, y);

    // Title
    ctx.font = "80px Arial";
    ctx.fillStyle = "#00FFFF";
    for (count = 120; count < 130; count++){ // Bold effect
        ctx.fillText("FOCUS BREAK", count, count+80);
        ctx.fillText("焦点を絞る", count+100, count+180);
    }
    ctx.fillStyle = "#ff00ff";
    ctx.fillText("FOCUS BREAK", count, count+80);
    ctx.fillText("焦点を絞る", count+100, count+180);

    // start button
    ctx.font = "25px Arial";
    ctx.globalAlpha = 0.2;
    ctx.fillStyle = "gray";
    ctx.fillRect((x / 2) - 410,(y / 2) - 32, 220, 44);
    ctx.globalAlpha = 1.0;
    ctx.fillStyle = "black";
    ctx.fillText("CLICK TO START", (x / 2) - 400, (y / 2));
    ctx.fillRect((x / 2) - 450,(y / 2) + 25, (300), 2);
    ctx.fillText("クリックして開始", (x / 2) - 400, (y / 2) + 65);

    // controls
    ctx.fillStyle = "#00FFFF";
    ctx.fillRect(x/2, y/2,     272, 40);// break
    ctx.fillRect(x/2, y/2+60,  272, 40);// focus
    ctx.fillRect(x/2, y/2+120, 272, 40);// warp
    ctx.font = "40px Impact";
    ctx.fillStyle = "#ff00ff";
    ctx.globalAlpha = 0.5;
    ctx.fillText("Space to Break", x/2, y/2 + 38);
    ctx.fillText("Shift to Focus", x/2, y/2 + 100);
    ctx.fillText("Click to warp" , x/2, y/2 + 160);

    // horizontal banners
    ctx.globalAlpha = 1.0;
    ctx.font = "40px Arial";
    ctx.fillStyle = "#00FFFF";
    ctx.fillRect(0,34, window.innerWidth, 30);
    ctx.fillRect(0,window.innerHeight - 66, window.innerWidth, 30);
    ctx.fillStyle = "#ff00ff";
    ctx.fillRect(0,40, window.innerWidth, 20);
    ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
    ctx.fillStyle = "black";
    ctx.globalAlpha = 0.7;
    ctx.fillRect(0,y - 40, x, 2);
    ctx.fillRect(0,60,x, 2);
    
    // slogan
    ctx.globalAlpha = 1.0;
    ctx.fillStyle = "#ff00ff";
    ctx.fillText(sloganText,sloganX,sloganY);
    if (sloganText == "Bug Free!"){
        for (count = 1; count < 40; count++){ // Bold effect
                ctx.fillText("Bug Free!",sloganX-40+count,sloganY-40+count);
                ctx.fillStyle = getRandomColor();
            }
    }

    // Options
     var boxX = 256;
     var boxY = 40;
     var Xoffset = 0;
     var Yoffset = boxX/2;
     ctx.fillRect(x/2, (y - Yoffset), boxX, boxY);
     ctx.fillText("Options", (x / 2) , (y - Yoffset));

     ctx.fillStyle = "black";
     ctx.fillRect((x/2 + (boxX / 16)), (y - Yoffset + (boxY / 4)), boxX/3, boxY/2);
     ctx.fillRect((x/2 + (boxX / 16)*8), (y - Yoffset + (boxY / 4)), boxX/3, boxY/2);

     ctx.fillStyle = "pink";
     ctx.fillText("Options", (x/2 + (boxX / 16)), (y - Yoffset + (boxY / 4))+10);
}

function startGame(e) {
    if (firstRun) {
        clearInterval(myInterval1);
        clearInterval(myInterval2);
        clearInterval(myInterval3);
        clearInterval(myInterval4);
        clearInterval(myInterval5);
        clearInterval(myInterval6);
        loadAudio();
        aud_click.play();
        startDate = new Date();
        gamePiece = new component(20 - perfectClear, 20 - perfectClear, gamePieceColor, e.pageX, e.pageY);
    }
    gameArea.start();
    firstRun = false;
    gameStart = true;
    alive = true;
    pause = false;
    invincible = false;
}

function wait(time) {
    setTimeout(startNextLevel, time)
}

function startNextLevel() {
    gameArea.clear();
    startGame();
    setAudioVolume(all_songs, musicVolume);
}

function gameOver() { // you dies
    alive = false;
    invincible = false;
    invincibleTime = 0;
    resumeSpeed();
    setAudioVolume(all_songs, musicVolume);
    gameArea.stop();
    gameArea.clear();
    objects_slow = [];
    objects_medium = [];
    objects_fast = [];
    objects_hyper = [];
    objects_powerup_break = [];
    objects_powerup_score = [];
    ctx = gameArea.canvas.getContext("2d");
    ctx.font = "60px Arial";
    ctx.fillStyle = "red";
    gameArea.canvas.style.cursor = "default";
    if (score >= scoreLimit) { // Next level
        level++; 
        if (level == 16){ // true finish
            var endDate = new Date();
            var completionTime = endDate - startDate;
            ctx.fillText("Time: "+millisToMinutesAndSeconds(completionTime), x / 2 - 350, y / 2);
            if (deaths == 0){
                ctx.fillText("Flawless Victory", x / 2 - 350, y / 2 - 175);
            } else {
                ctx.fillText("Can you continue?", x / 2 - 350, y / 2 - 175);
                ctx.fillText(deaths+" mistakes", x / 2 - 350, y / 2 - 87);
            }
            return;
        } else if (level == 10){ // you win
            ctx.fillStyle = "Black";
            ctx.fillText("Victory is a state of mind", x / 2 - 350, y / 2 - 175);
            ctx.fillText("勝利は心の状態です", x / 2 - 275, y / 2 - 75);
            ctx.fillRect(0,40, window.innerWidth, 20);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
            wait(5000);
        } else if (level == 9){
            setAudioVolume(all_songs, 0.0);
            aud_bomb.play();
            ctx.font = "80px Arial";
            ctx.fillStyle = "red";
            for (count = 0; count < 3; count++){ // bold effect
                ctx.fillText("WARNING 警告", (x / 2 - 300)+count, (y / 2 - 175)+count);
                ctx.fillText("多数の敵が接近する", (x / 2 - 400)+count, (y / 2 - 75)+count);
            }            
            ctx.fillRect(0,40, window.innerWidth, 30);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 30);
            wait(3500);
        } else if (deaths == 0) { // perfect clear
            aud_menuSound.volume = 0.2;
            aud_menuSound.play();
            ctx.fillStyle = "#48D1CC";
            ctx.font = "60px Arial";
            if (perfectClear < 7){ // decrease hitbox size
                perfectClear++;
                ctx.fillText("Hitbox size decreased!", (x / 2 - 325), (y / 2 - 75));
                ctx.fillText("ヒットボックスを減らす!", (x / 2 - 325), (y / 2 + 50));       
            }
            for (count = 0; count < 3; count++){
                ctx.fillText("+ Perfect 完全 +", (x / 2 - 200)+count, (y / 2 - 175)+count);
            }  
            ctx.fillRect(0,40, window.innerWidth, 20);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
            wait(3000);
        } else { // normal clear
            ctx.fillText("Enemies Approaching", x / 2 - 300, y / 2 - 175);
            ctx.fillText("非常に大きな敵に接近する危険!", x / 2 - 425, y / 2 - 50);
            ctx.fillText("慎重に進んでください!", x / 2 - 300, y / 2 + 25);
            wait(3000);
        }
    } else { // you lose
        deaths += 1; 
        aud_death.play();
        ctx.fillText("Score: " + score, x / 2 - 200, y / 2 - 75);
        switch (score) { // death slogans
            case 69:deathSlogan = "😂";break;
            case 420:deathSlogan = "blaze it";break;
            case 666:deathSlogan = "😈";break;
            case 911:deathSlogan = "TOO SOON";break;
            case 999:deathSlogan = "TOO HARD";break;
            default: deathSlogan = "";break;
        }
        if (deathSlogan != ""){
            //ctx.textAlign = "center";
            ctx.fillText(deathSlogan, x / 2 -150, y / 2 +25);  
        }
        if (score >= 900) {
            ctx.fillText("So Close", x / 2 - 200, y / 2 - 175);
        } else if (score <= 100) {
            ctx.fillText("...", x / 2 - 100, y / 2 - 175);
        } else {
            ctx.fillText("Try Again", x / 2 - 200, y / 2 - 175);
            ctx.fillText("再試行する", x / 2 - 200, y / 2 +25);  
        }
        wait(2500);
    }
    score = 0;
}

function resumeSpeed() {
    focused = false;
    if (alive) {
        gamePiece.width = 20 - perfectClear;
        gamePiece.height = 20 - perfectClear;
    }
    speed = 1;
    setAudioSpeed(all_songs, 1.0);
}

function setSlowSpeed(){
    focused = true;
    gamePiece.width = 15 - perfectClear;
    gamePiece.height = 15 - perfectClear;
    speed = speed_slow;
    setAudioSpeed(all_songs, 0.75);
}

function setFastSpeed(){
    focused = true;
    gamePiece.width = 15 - perfectClear;
    gamePiece.height = 15 - perfectClear;
    speed = speed_fast;
    setAudioSpeed(all_songs, 1.2);
}

function setBreak(scorePenalty){
    if (!invincible) {
        objects_powerup_break = []; // destroy powerups on break
        objects_powerup_score = [];
        invincible = true;
        score += -scorePenalty;
        setAudioSpeed(all_songs, 1.0);
    }
}

function checkBounds(e,x1,x2,y1,y2){ // check if mouse click is within x/y coords
    var mouseX = e.clientX - 8;
    var mouseY = e.clientY - 8;
    if (mouseX > (x / 2) - x1 && mouseX < (x / 2) + x2 && mouseY > (y / 2) - y1 && mouseY < (y / 2) + y2) {
        return true;
    }
}

var gameArea = {
    canvas: document.createElement("canvas"),
    load: function () {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        window.addEventListener('click', function (e) {
            if (gameStart == false && checkBounds(e,410,-190,32,14)) { // CLICK TO START
                startGame(e);
            } else if (gameStart == false && checkBounds(e,0,272,0,40)) { // SPACE TO BREAK
                alert("SPACEBAR or MIDDLE MOUSE BUTTON = BREAK - Become invincible briefly.  Lose score, emergency use only!");
            } else if (gameStart == false && checkBounds(e,0,272,60,100)) { // SHIFT TO FOCUS
                alert("SHIFT or LEFT MOUSE BUTTON = FOCUS - Slows time and decrease hitbox size.  Earn no score, use in a tight spot.");
            } else if (gameStart == false && checkBounds(e,0,272,120,160)) { // CLICK TO WARP
                alert("CTRL or RIGHT MOUSE BUTTON: WARP - Speeds up time.  Earn double score, you madman.");
            }
        })
        window.addEventListener('mousedown', function (e) {
            e.preventDefault();
             if (alive) {
                if (e.which == 3) { // right mouse button. keyCode = 3
                    setFastSpeed();
                }
                if (e.which == 1) { // left mouse button. keyCode = 1
                    setSlowSpeed();
                }
                if (e.which == 2) { // middle mouse button. keyCode = 2
                    if (alive) {
                        setBreak(scorePenalty);
                    }
                }
            }
        })
        window.addEventListener('mouseup', function (e) {
            e.preventDefault;
            if (e.which == 3 || e.which == 1) { // resume speed if LMB or RMB is released
                resumeSpeed();
            }
        })
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            if (e.which == 80 || e.keyCode == 80) { // P. keyCode = 112
                if (pause){
                    pause = false;
                } else {
                    pause = true;
                }
            }
            if (e.which == 32 || e.keyCode == 32) { // SPACEBAR. keyCode = 32
                if (alive) {
                    setBreak(scorePenalty);
                }
            }
            if (e.shiftKey) { // SHIFT. keyCode = 16
                if (alive) {
                    setSlowSpeed();
                }
            }
            if (e.ctrlKey) { // CTRL. keyCode = 17
                if (alive) {
                    setFastSpeed();
                }
            }
        })
        window.addEventListener('keyup', function (e) { // resume speed if CTRL or SHIFT key is released
            if (e.which == 16 || e.keyCode == 16 || e.which == 17 || e.keyCode == 17) {
                resumeSpeed();
            } 
        })
    },
    start: function () {
        this.canvas.style.cursor = "none"; // hide the original cursor
        this.context = this.canvas.getContext("2d");
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 10); // frame rate, object speed
        window.addEventListener('mousemove', function (e) {
            gameArea.x = e.pageX;
            gameArea.y = e.pageY;
            if (invincible) {
                gamePiece.height = 20 - perfectClear;
                gamePiece.width = 20 - perfectClear;
            } else {
                if (focused){
                    gamePiece.height = 15 - perfectClear;
                    gamePiece.width = 15 - perfectClear;
                } else {
                    gamePiece.height = 20 - perfectClear;
                    gamePiece.width = 20 - perfectClear;
                    gamePiece = new component(20 - perfectClear, 20 - perfectClear, gamePieceColor, e.pageX, e.pageY);
                }
            }
        })
    },
    clear: function () {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },
    stop: function () {
        clearInterval(this.interval);
    }
}

function component(width, height, color, x, y) {
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;
    this.x = x;
    this.y = y;
    this.update = function () {
        ctx = gameArea.context;
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
    }

    this.crashWith = function (otherobj) {
        var myleft = this.x;
        var myright = this.x + (this.width);
        var mytop = this.y;
        var mybottom = this.y + (this.height);
        var otherleft = otherobj.x;
        var otherright = otherobj.x + (otherobj.width);
        var othertop = otherobj.y;
        var otherbottom = otherobj.y + (otherobj.height);
        var crash = true;
        if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
            crash = false;
        }
        return crash;
    }
}

function detectCollision(objects) { // detect collision between gamePiece and object group
    for (i = 0; i < objects.length; i += 1) {
        if (gamePiece.crashWith(objects[i])) { // collision
            return true;
        }
    }
}

function moveObstacles(objects, amount) {
    for (i = 0; i < objects.length; i += 1) {
        objects[i].x += -amount * speed; // speed of obstacles
        objects[i].update();
    }
}

function movePowerUps(objects, amount, size, color) {
    for (i = 0; i < objects.length; i += 1) { // move powerups 
        objects[i].x += -amount * speed;
        obj_x = objects[i].x;
        obj_y = objects[i].y;
        objects = [];
        objects.push(new component(size, size, color, obj_x, obj_y));
        objects[i].update();
    }
}

function updateGameArea() {
    if (!pause){
        var x, height, gap, minHeight, maxHeight, minGap, maxGap;
        if (!invincible) { // detect collisions
            if (detectCollision(objects_medium) || detectCollision(objects_fast) || detectCollision(objects_hyper) || detectCollision(objects_slow)) {
                gameOver();
                return;
            }
        }

        if (detectCollision(objects_powerup_break)) { // powerup collision
            aud_powerUp.play();
            objects_powerup_break = [];
            setBreak(0);
        }

        if (detectCollision(objects_powerup_score)) { // powerup collision
            aud_pickupCoin.play();
            objects_powerup_score = [];
            score += powerupScoreBonus;
        }

        gameArea.clear();
        gameArea.frameNo += 1;

        if (invincible) {
            ctx.fillRect((gamePiece.x - 50 + invincibleTime / 2), (gamePiece.y - 25), (invincibleTimeMax - invincibleTime), (15)); // display invincible progress
            if (focused) {
                invincibleTime += 2;
                gamePiece = new component(15 - perfectClear, 15 - perfectClear, getRandomColor(), gamePiece.pageX, gamePiece.pageY);
            } else {
                invincibleTime += 1;
                gamePiece = new component(20 - perfectClear, 20 - perfectClear, getRandomColor(), gamePiece.pageX, gamePiece.pageY);
            }
            if (invincibleTime >= invincibleTimeMax) {
                if (focused) {
                    gamePiece = new component(15 - perfectClear, 15 - perfectClear, gamePieceColor, gamePiece.pageX, gamePiece.pageY);
                } else {
                    gamePiece = new component(20 - perfectClear, 20 - perfectClear, gamePieceColor, gamePiece.pageX, gamePiece.pageY);
                }
                invincible = false;
                invincibleTime = 0;
                setAudioSpeed(all_songs, 1.0);
            }
        }

        ctx.fillStyle = "black";
        ctx.font = "40px Arial";
        switch (level) { // level names
            case 1:
                ctx.fillText("Breath Easy", 80, window.innerHeight - 60);
                    break;
            case 2:
                ctx.fillText("Clear Your Mind", 80, window.innerHeight - 60);
                    break;
            case 3:
                ctx.fillText("Looking Inward", 80, window.innerHeight - 60);
                    break;
            case 4:
                ctx.fillText("Flow", 80, window.innerHeight - 60);
                    break;
            case 5:
                ctx.fillText("Reaching", 80, window.innerHeight - 60);
                    break;
            case 6:
                if (deaths == 0){
                    ctx.fillText("Seeking Perfection", 80, window.innerHeight - 60);
                } else {
                    ctx.fillText("Past mistakes", 80, window.innerHeight - 60);
                }
                    break;
            case 7:
                ctx.fillText("Looking Outward", 80, window.innerHeight - 60);
                    break;
            case 8:
                ctx.fillText("Memory Advance", 80, window.innerHeight - 60);
                    break;
            case 9:
                ctx.fillText("Self Destruct", 80, window.innerHeight - 60);
                    break;
            case 10:
                if (deaths == 0){
                    ctx.fillText("Perfection", 80, window.innerHeight - 60);
                } else {
                    ctx.fillText("Remains", 80, window.innerHeight - 60);
                }
                    break;
            case 11:
                ctx.fillText("Afterlife", 80, window.innerHeight - 60);
                    break;
            case 12:
                ctx.fillText("Desolation", 80, window.innerHeight - 60);
                    break;
            case 13:
                ctx.fillStyle = "red";
                ctx.fillRect(900, 0, 100, window.innerHeight);
                ctx.fillStyle = "black";
                ctx.fillText("Rebirth", 80, window.innerHeight - 60);
                    break;
            case 14:
                ctx.fillRect(900, 0, 100, window.innerHeight);
                ctx.fillRect(1100, 0, 2000, window.innerHeight);
                ctx.fillText("...", 80, window.innerHeight - 60);
                    break;
            default:
                ctx.fillText("How did this happen?", 80, window.innerHeight - 60);
                    break;
            }
        // Object Spawning
        if (everyinterval(250)) { // powerup
            if (!focused){
                if (~~(Math.random()*2) ? true : false) { // break powerup
                    objects_powerup_break.push(new component(15, 15, getRandomColor, document.body.clientWidth, Math.random() * window.innerHeight));
                } else { // score powerup
                    objects_powerup_score.push(new component(20, 20, getRandomColorGold(), document.body.clientWidth, Math.random() * window.innerHeight));
                }   
            }   
        }
        if (level >= 1) { // level 1 - vertical black bars
            if (gameArea.frameNo == 1 || everyinterval(50 / speed)) { // distance vertical bars
                v_x = gameArea.canvas.width;
                minHeight = 20;
                maxHeight = window.innerHeight - 60;
                height = Math.floor(Math.random() * (maxHeight - minHeight + 1) + minHeight);
                minGap = 85-(level*2);
                maxGap = 125-(level*2);
                gap = Math.floor(Math.random() * (maxGap - minGap + 1) + minGap);
                objects_medium.push(new component(20, height, "black", v_x, 0));
                objects_medium.push(new component(20, v_x - height - gap, "black", v_x, height + gap));
            }
        }
        if (level >= 2) { // level 2 - black slow moving large
            if (gameArea.frameNo == 1 || everyinterval(100 / speed)) {
                objects_hyper.push(new component(window.innerHeight / 8, window.innerHeight / 8, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 3) { // level 3 - black medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)) {
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 4) { // level 4 - red small
            if (gameArea.frameNo == 1 || everyinterval(20 / speed)) {
                objects_medium.push(new component(10, 10, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 5) { // level 5 - black medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)){
                r = getRandomInteger(0,250);
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth + r, Math.random() * window.innerHeight))
            }
        }
        if (level >= 6) { // level 6 - black medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)){
                r = getRandomInteger(0,250);
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth + r, Math.random() * window.innerHeight))
            }
        }
        if (level >= 7) { // level 7 - black medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)){
                r = getRandomInteger(0,250);
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth + r, Math.random() * window.innerHeight))
            }
        }
        if (level >= 8) { // level 8 - black medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)){
                r = getRandomInteger(0,250);
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth + r, Math.random() * window.innerHeight))
            }
        }
        if (level >= 9){ // level 9 - red medium
            if (gameArea.frameNo == 1 || everyinterval((8) / speed)){
                objects_fast.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));  
            }
        }
        if (level == 10){ // level 10 - red medium, red big
            if (gameArea.frameNo == 1 || everyinterval((8) / speed)){
                objects_fast.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));  
            }
            if (gameArea.frameNo == 1 || everyinterval(200 / speed)) {
                objects_slow.push(new component(window.innerHeight / 4, window.innerHeight / 4, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 11){ // level 11 - nothing
            if (gameArea.frameNo == 1 || everyinterval(200 / speed)) {
                objects_medium.push(new component(10, 50, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 12) { // level 12 - black oblong
            if (gameArea.frameNo == 1 || everyinterval(20 / speed)) {
                objects_medium.push(new component(10, 50, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 13) { // level 13 - red medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)) {
                objects_fast.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 14){ // level 14 - red big, black medium
            if (gameArea.frameNo == 1 || everyinterval(150) / speed) {
                objects_slow.push(new component(window.innerHeight / 8, window.innerHeight / 8, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            } 
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)){
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }    
        if (level >= 15) { // level 15 - red medium,  black medium
            if (gameArea.frameNo == 1 || everyinterval((20) / speed)) {
                objects_fast.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));
                objects_fast.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight));
                setFastSpeed();
            }
        }
        
        movePowerUps(objects_powerup_break, 3, 15, getRandomColor());
        movePowerUps(objects_powerup_score, 3, 20, getRandomColorGold());

        moveObstacles(objects_slow, 1);
        moveObstacles(objects_medium, 2);
        moveObstacles(objects_fast, 4);
        moveObstacles(objects_hyper, 5);
        
        if (gameArea.x && gameArea.y) {
            gamePiece.x = gameArea.x;
            gamePiece.y = gameArea.y;
        }
        if (invincible) { // BREAK
            ctx.fillStyle = getRandomColor();
            ctx.globalAlpha = 0.75;
            ctx.font = "60px Arial";
            if (everyinterval(0.5)) {
                ctx.fillText("BREAK! 壊れる", 200, 200);
            }
            ctx.fillRect(0,40, window.innerWidth, 20);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
            ctx.font = "40px Arial";
            ctx.globalAlpha = 0.8;
            ctx.fillText(deaths, 50, 200); // show deaths
            ctx.fillText("Level " + level, 50, 300); // show level
            ctx.fillStyle = "red"; // color
            ctx.fillText(score, 50, 100);
            ctx.globalAlpha = 1.0;
        } else {
            ctx.fillStyle = "black"; // color
            ctx.fillText(score, 50, 100); // show score
            ctx.fillText(deaths, 50, 200); // show deaths
            ctx.fillText("Level " + level, 50, 300); // show level
        } if (speed == 1) {
            if (gameArea.frameNo % 2 == 0){
                score++;
            }
        } else if (speed == speed_slow) { // FOCUS
            ctx.globalAlpha = 0.75;
            ctx.fillRect(0,40, window.innerWidth, 30);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 30);
            ctx.fillStyle = "red";
            ctx.font = "60px Arial";
            ctx.fillText("FOCUS! 焦点", 200, 200);
            ctx.font = "40px Arial";
            ctx.fillText(score, 50, 100);
            ctx.globalAlpha = 1.0;
        } else if (speed == speed_fast){
            aud_danger.play();
            ctx.fillStyle = "red";
            ctx.globalAlpha = 0.8;
            ctx.fillRect(0,40, window.innerWidth, 30);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 30);
            ctx.globalAlpha = 1.0;
            ctx.font = "60px Arial";
            if (everyinterval(1)) {
                ctx.fillText("DANGER! 危険", 200, 200);
            }
            ctx.font = "40px Arial";
            ctx.fillStyle = getRandomColor();
            ctx.fillText("+", 120, 100);
            ctx.fillText(score, 50, 100);
            score += 1;
        }
        gamePiece.update();
        if (score >= scoreLimit) { // score limit reached
            if (level == 9){ // play until you die
                ctx.fillStyle = getRandomColor();
                ctx.fillText(score, 50, 100);
            } else {
                gameOver();
            }
        }
    }  else {  // pause
        ctx.fillStyle = "red";
        ctx.fillText("PAUSED", 156, 156);
    } 
}

function everyinterval(n) {
    if ((((gameArea.frameNo) / (n)) % 2) == 0) { return true; }
    return false;
}

function unloadScrollBars() {
    document.documentElement.style.overflow = 'hidden';  // firefox, chrome
    document.body.scroll = "no"; // ie only
}

function getRandomColor() {  // generate a random color
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

function getRandomColorGold() {
  // Define the range of shades for gold color
  var minHue = 25; // Minimum hue value for gold color in degrees (corresponds to yellow)
  var maxHue = 100; // Maximum hue value for gold color in degrees
  var saturation = 100; // Saturation value for gold color
  var lightness = 50; // Lightness value for gold color

  // Generate a random hue within the specified range
  var hue = Math.floor(Math.random() * (maxHue - minHue + 1)) + minHue;

  // Convert the HSL color to RGB
  var hslToRgb = function (h, s, l) {
    h /= 360;
    s /= 100;
    l /= 100;
    var r, g, b;

    if (s === 0) {
      r = g = b = l;
    } else {
      var hueToRgb = function (p, q, t) {
        if (t < 0) t += 1;
        if (t > 1) t -= 1;
        if (t < 1 / 6) return p + (q - p) * 6 * t;
        if (t < 1 / 2) return q;
        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
        return p;
      };

      var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      var p = 2 * l - q;

      r = hueToRgb(p, q, h + 1 / 3);
      g = hueToRgb(p, q, h);
      b = hueToRgb(p, q, h - 1 / 3);
    }

    return {
      r: Math.round(r * 255),
      g: Math.round(g * 255),
      b: Math.round(b * 255),
    };
  };

  // Convert HSL to RGB
  var color = hslToRgb(hue, saturation, lightness);

  // Convert RGB to hex notation
  var rgbToHex = function (r, g, b) {
    var componentToHex = function (component) {
      var hex = component.toString(16);
      return hex.length === 1 ? "0" + hex : hex;
    };

    return (
      "#" +
      componentToHex(r) +
      componentToHex(g) +
      componentToHex(b)
    );
  };

  // Return the hex color as a string
  return rgbToHex(color.r, color.g, color.b);
}

function getRandomInteger(min, max) {
    return Math.floor(Math.random() * (max - min) ) + min;
}

function millisToMinutesAndSeconds(millis) { // ms conversions
  var minutes = Math.floor(millis / 60000);
  var seconds = ((millis % 60000) / 1000).toFixed(0);
  return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
}

</script>
</body>
</html>