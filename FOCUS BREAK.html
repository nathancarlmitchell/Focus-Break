<!--
    Ideas:

    To create a scalable window
    Isolate drawing to a separate function
    multiple or divide by a factor depending on screen resolution
    Change size and position

    MOBILE TOUCH

    POWERUP that adds to score

    MOVETO function?
    - smooth mouse movements
-->

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF8"  />
</head>
<body onload="onLoad()" onresize="windowResize()" onmousemove="mouseMove()" oncontextmenu="return false;">
    <div id="audio">
        <!--    <iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/users/5333822&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
        iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/531718938&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
        -->
        <iframe src="music\fx 11.wav" allow="autoplay" style="display:none" id="iframeAudio"></iframe>
        <audio id="audio1" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 01 Before U Go.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio2" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 02 Reflex.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio3" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 03 Blood (feat. Fifty Grand).mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio4" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 04 Undefined.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio5" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 05 Lay.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio6" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 06 Kitty Kat.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio7" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 07 Too Late.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio8" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 08 Midnight (Cavalier Version).mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio9" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 09 Commas.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio10" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 10 Gone.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="audio11" style="visibility:hidden" >
            <source src="music\Cavalier - Vol. 8 - 11 Love U.mp3" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="bombSFX" style="visibility:hidden">
            <source src="music\BOMB_SIREN-BOMB_SIREN-247265934.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx11" style="visibility:hidden">
            <source src="music\fx 11.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="fx14" style="visibility:hidden">
            <source src="music\fx 14.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="danger" style="visibility:hidden">
            <source src="music\72.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
        <audio id="menusound2" style="visibility:hidden">
            <source src="music\Menu Sounds_2.wav" type="audio/mpeg"> Your browser does not support the audio element.
        </audio>
    </div>
<script>


var x = window.innerWidth;
var y = window.innerHeight;
var gamePiece;
var gamePieceColor = "blue";
var myObstacles1 = [];
var myObstacles2 = [];
var myObstacles3 = [];
var myObstacles4 = [];
var myObstaclesPowerup = [];
var myObstaclesPowerupGold = [];
var score = 0;
var scoreLimit = 1000;
var scorePenalty = 200; // point deduction for break
var deaths = 0;
var invincibleTime = 0;
var perfectClear = 0;
var level = 1;
var speed = 1;
var invincible = false;
var gameStart = false;
var alive = false;
var focused = false;
var firstRun = true;
var pause = false;
var startDate;
var sloganY = 120;
var sloganX = 100;
var sloganText = "";
var deathSlogan = "";
var deathSlogan = score;
var musicVolume = 0.2;
var aud1 = document.getElementById("audio1");
var aud2 = document.getElementById("audio2");
var aud3 = document.getElementById("audio3");
var aud4 = document.getElementById("audio4");
var aud5 = document.getElementById("audio5");
var aud6 = document.getElementById("audio6");
var aud7 = document.getElementById("audio7");
var aud8 = document.getElementById("audio8");
var aud9 = document.getElementById("audio9");
var aud10 = document.getElementById("audio10");
var aud11 = document.getElementById("audio11");
var aud_bomb = document.getElementById("bombSFX");
var aud_menuSound = document.getElementById("menusound2");
var aud_death = document.getElementById("fx14");
var aud_danger = document.getElementById("danger");

var click_to_start_bounds = false;
var space_to_break_bounds = false;
var shift_to_focus_bounds = false;
var click_to_warp_bounds  = false;

const myInterval = setInterval(updateSloganText, 3000);
const myInterval2 = setInterval(focus_break_colors, 100);
const myInterval3 = setInterval(click_to_start_colors, 50);
const myInterval4 = setInterval(space_to_break_colors, 100);
const myInterval5 = setInterval(shift_to_focus_colors, 100);
const myInterval6 = setInterval(click_to_warp_colors, 100);

function loadAudio(){ 
    setAudioVolume(musicVolume);
    aud1.onended = function() {
        aud2.play();
    };
    aud2.onended = function() {       
        aud3.play();
    };
    aud3.onended = function() {
        aud4.play();
    };
    aud4.onended = function() {;
        aud5.play();
    };
    aud5.onended = function() {;
        aud6.play();
    };
    aud6.onended = function() {;
        aud7.play();
    };
    aud7.onended = function() {;
        aud8.play();
    };
    aud8.onended = function() {;
        aud9.play();
    };
    aud9.onended = function() {;
        aud10.play();
    };
    aud10.onended = function() {;
        aud11.play();
    };
    aud11.onended = function() {;
        aud1.play();
    };
    if (firstRun){
        aud1.play();
    }
}

function setAudioSpeed(x) { // set audio playback rate for all songs
    aud1.playbackRate = x;
    aud2.playbackRate = x;
    aud3.playbackRate = x;
    aud4.playbackRate = x;
    aud5.playbackRate = x;
    aud6.playbackRate = x;
    aud7.playbackRate = x;
    aud8.playbackRate = x;
    aud9.playbackRate = x;
    aud10.playbackRate = x;
    aud11.playbackRate = x;
}

function setAudioVolume(x) { // set audio volume for all songs
    aud1.volume = x;
    aud2.volume = x;
    aud3.volume = x;
    aud4.volume = x;
    aud5.volume = x;
    aud6.volume = x;
    aud7.volume = x;
    aud8.volume = x;
    aud9.volume = x;
    aud10.volume = x;
    aud11.volume = x;
}

function mouseMove() { // detect mouse on start screen
    var mouseX = event.clientX - 8;
    var mouseY = event.clientY - 8;
    if (firstRun) {
        if(mouseX > (x / 2) - 410 && mouseX < (x / 2) - 190 && mouseY > (y / 2) - 32 && mouseY < (y / 2) + 14) { // CLICK TO START
            click_to_start_bounds = true;
        }
        else if(mouseX > (x / 2) && mouseX < (x / 2) + 272 && mouseY > (y / 2) && mouseY < (y / 2) + 40) { // SPACE TO BREAK
            space_to_break_bounds = true;
        }
        else if(mouseX > (x / 2) && mouseX < (x / 2) + 272 && mouseY > (y / 2) + 60 && mouseY < (y / 2) + 100) { // SHIFT TO FOCUS
            shift_to_focus_bounds = true;
        }
        else if(mouseX > (x / 2) && mouseX < (x / 2) + 272 && mouseY > (y / 2) + 120 && mouseY < (y / 2) + 160) { // CLICK TO WARP
            click_to_warp_bounds = true;
        } else {
            if (click_to_start_bounds || space_to_break_bounds || shift_to_focus_bounds || click_to_warp_bounds) {
                drawStartScreen();       
                click_to_start_bounds = false;
                shift_to_focus_bounds = false;
                space_to_break_bounds = false;
                click_to_warp_bounds  = false;
            }
        }
    }
}

function focus_break_colors(){ // Flashing colors on start screen
    ctx = gameArea.canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.font = "80px Arial";
    ctx.fillStyle = getRandomColor();
    for (count = 127; count < 130; count++){ // Bold effect
        ctx.fillText("FOCUS BREAK", count, count+80);
        ctx.fillText("焦点を絞る", count+100, count+180);
    }
    ctx.fillStyle = "#ff00ff";
    ctx.fillText("FOCUS BREAK", count, count+80);
    ctx.fillText("焦点を絞る", count+100, count+180);
}

function click_to_start_colors(){ // Flashing colors on start screen
    if (click_to_start_bounds) {
        ctx.globalAlpha = 0.2;
        ctx.fillStyle = getRandomGoldColorHex();
        ctx.fillRect((x / 2)-410,(y / 2) - 32, (220), 44);
        ctx.fillRect((x / 2)-410,(y / 2) - 32, (220), 44);
        ctx.font = "25px Arial";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "black";
        ctx.fillText("CLICK TO START", (x / 2)-400, (y / 2));
    }
}

function space_to_break_colors(){ // Flashing colors on start screen
    if (space_to_break_bounds) {
        ctx.fillStyle = "#000000";
        ctx.fillRect(x/2, y/2, 272, 40);
        ctx.font = "40px Impact";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = getRandomColor();
        ctx.fillText("Space to Break", x / 2 , y / 2 +38);
        ctx.globalAlpha = 1.0;
    }
}

function shift_to_focus_colors(){ // Flashing colors on start screen
    if (shift_to_focus_bounds) {
        ctx.fillStyle = "#000000";
        ctx.fillRect(x/2, y/2+60, 272, 40);
        ctx.font = "40px Impact";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = getRandomColor();
        ctx.fillText("Shift to Focus", x / 2, y / 2 + 100);
        ctx.globalAlpha = 1.0;
    }
}

function click_to_warp_colors(){ // Flashing colors on start screen
    if (click_to_warp_bounds) {
        ctx.fillStyle = "#000000";
        ctx.fillRect(x/2, y/2+120, 272, 40);
        ctx.font = "40px Impact";
        ctx.fillStyle = "#ff00ff";
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = getRandomColor();
        ctx.fillText("Click to warp", x / 2, y / 2 + 160);
        ctx.globalAlpha = 1.0;
    }
}

function onLoad() {
    gameArea.load();
    unloadScrollBars();
    updateSloganText();
    drawStartScreen();
}

function updateSloganText() {
    var slogan = Math.floor(Math.random() * 18) + 1;
    switch (slogan) { // slogans
        case 1:sloganText = "TOO HARD";break;
        case 2:sloganText = "Now in Color!";break;
        case 3:sloganText = "Vegan!";break;
        case 4:sloganText = "Siezure inducing!";break;
        case 5:sloganText = "Advanced!";break;
        case 6:sloganText = "Fresh!";break;
        case 7:sloganText = "Spicy!";break;
        case 8:sloganText = "Gotta Go Fast!";break;
        case 9:sloganText = "Classic";break;
        case 10:sloganText = "Coming Soon!";break;
        case 11:sloganText = "4K 1080p";break;
        case 12:sloganText = "Lite";break;
        case 13:sloganText = "今は日本語です！";break;
        case 14:sloganText = "Version 2";break;
        case 15:sloganText = "Bug Free!";break;
        case 16:sloganText = "Not Lame!";break;
        case 17:sloganText = "...";break;
        case 18:sloganText = "ULTRA";break;
        case 19:sloganText = "";break;
    }
    drawStartScreen();
}

function windowResize() {
    gameArea.load();
    if (!gameStart) {
        drawStartScreen();
    }
}

function drawStartScreen() { // draw the start screen
    ctx = gameArea.canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.font = "80px Arial";
    ctx.fillRect(0, 0, x, y);
    ctx.fillStyle = "#00FFFF";
    for (count = 120; count < 130; count++){ // Bold effect
        ctx.fillText("FOCUS BREAK", count, count+80);
        ctx.fillText("焦点を絞る", count+100, count+180);
    }
    ctx.fillRect(x/2, y/2, 272, 40);
    ctx.fillRect(x/2, y/2+60, 272, 40);
    ctx.fillRect(x/2, y/2+120, 272, 40);
    ctx.fillStyle = "#ff00ff";
    ctx.fillText("FOCUS BREAK", count, count+80);
    ctx.fillText("焦点を絞る", count+100, count+180);
    ctx.font = "25px Arial";
    ctx.fillStyle = "black";

    ctx.globalAlpha = 0.2;
    ctx.fillStyle = "gray";
    ctx.fillRect((x / 2) - 410,(y / 2) - 32, 220, 44);
    ctx.globalAlpha = 1.0;
    ctx.fillStyle = "black";
    ctx.fillText("CLICK TO START", (x / 2) - 400, (y / 2));

    ctx.fillRect((x / 2) - 450,(y / 2) + 25, (300), 2);
    ctx.fillText("クリックして開始", (x / 2) - 400, (y / 2) + 65);

    ctx.font = "40px Impact";
    ctx.fillStyle = "#ff00ff";
    ctx.globalAlpha = 0.5;
    ctx.fillText("Space to Break", x / 2 , y / 2 + 38);
    ctx.fillText("Shift to Focus", x / 2, y / 2 + 100);
    ctx.fillText("Click to warp", x / 2, y / 2 + 160);

    ctx.globalAlpha = 1.0;
    ctx.font = "40px Arial";
    ctx.fillStyle = "#00FFFF";
    ctx.fillRect(0,34, window.innerWidth, 30);
    ctx.fillRect(0,window.innerHeight - 66, window.innerWidth, 30);
    ctx.fillStyle = "#ff00ff";
    ctx.fillRect(0,40, window.innerWidth, 20);
    ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
    ctx.fillStyle = "black";
    ctx.globalAlpha = 0.7;
    ctx.fillRect(0,y - 40, x, 2);
    ctx.fillRect(0,60,x, 2);
    ctx.globalAlpha = 1.0;
    ctx.fillStyle = "#ff00ff";
    ctx.fillText(sloganText,sloganX,sloganY);
    if (sloganText == "Bug Free!"){
        for (count = 1; count < 40; count++){ // Bold effect
                ctx.fillText("Bug Free!",sloganX-40+count,sloganY-40+count);
                ctx.fillStyle = getRandomColor();
            }
    }
    // Options
     var boxX = 256;
     var boxY = 40;
     var Xoffset = 0;
     var Yoffset = boxX/2;
     ctx.fillRect(x/2, (y - Yoffset), boxX, boxY);
     ctx.fillText("Options", (x / 2) , (y - Yoffset));
     ctx.fillStyle = "black";

     ctx.fillRect((x/2 + (boxX / 16)), (y - Yoffset + (boxY / 4)), boxX/3, boxY/2);
     ctx.fillRect((x/2 + (boxX / 16)*8), (y - Yoffset + (boxY / 4)), boxX/3, boxY/2);

     ctx.fillStyle = "pink";
     ctx.fillText("Options", (x/2 + (boxX / 16)), (y - Yoffset + (boxY / 4))+10);
}

function startGame(e) {
    clearInterval(myInterval);
    clearInterval(myInterval2);
    clearInterval(myInterval3);
    clearInterval(myInterval4);
    clearInterval(myInterval5);
    clearInterval(myInterval6);
    loadAudio();
    gameArea.start();
    if (firstRun){
        startDate = new Date();
        gamePiece = new component(20 - perfectClear, 20 - perfectClear, gamePieceColor, e.pageX, e.pageY);
    }
    firstRun = false;
    gameStart = true;
    alive = true;
    pause = false;
    invincible = false;
}

function wait(x) {
    setTimeout(startNextLevel, x)
}

function startNextLevel() {
    gameArea.clear();
    startGame();
    setAudioVolume(0.2);
}

function gameOver() { // you dies
    alive = false;
    invincible = false;
    invincibleTime = 0;
    resumeSpeed();
    setAudioVolume(0.2);
    gameArea.stop();
    gameArea.clear();
    myObstacles1 = [];  // overcome all obstacles
    myObstacles2 = [];
    myObstacles3 = [];
    myObstacles4 = [];
    myObstaclesPowerup = [];
    myObstaclesPowerupGold = [];
    ctx = gameArea.canvas.getContext("2d");
    ctx.font = "60px Arial";
    ctx.fillStyle = "red";
    gameArea.canvas.style.cursor = "default";
    if (score >= scoreLimit) { // Next level
        level++; 
        if (level == 16){ // true finish
            var endDate = new Date();
            var completionTime = endDate - startDate;
            ctx.fillText("Time: "+millisToMinutesAndSeconds(completionTime), x / 2 - 350, y / 2);
            if (deaths == 0){
                ctx.fillText("Flawless Victory", x / 2 - 350, y / 2 - 175);
            } else {
                ctx.fillText("Can you continue?", x / 2 - 350, y / 2 - 175);
                ctx.fillText(deaths+" mistakes", x / 2 - 350, y / 2 - 87);
            }
            return;
        } else if (level == 10){ // you win
            ctx.fillStyle = "Black";
            ctx.fillText("Victory is a state of mind", x / 2 - 350, y / 2 - 175);
            ctx.fillText("勝利は心の状態です", x / 2 - 275, y / 2 - 75);
            ctx.fillRect(0,40, window.innerWidth, 20);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
            wait(5000);
        } else if (level == 9){
            setAudioVolume(0.0);
            aud_bomb.volume = 0.3;
            aud_bomb.play();
            ctx.font = "80px Arial";
            ctx.fillStyle = "red";
            for (count = 0; count < 3; count++){ // bold effect
                ctx.fillText("WARNING 警告", (x / 2 - 300)+count, (y / 2 - 175)+count);
                ctx.fillText("多数の敵が接近する", (x / 2 - 400)+count, (y / 2 - 75)+count);
            }            
            ctx.fillRect(0,40, window.innerWidth, 30);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 30);
            wait(3500);
        } else if (deaths == 0) { // perfect clear
            aud_menuSound.volume = 0.2;
            aud_menuSound.play();
            ctx.fillStyle = "#48D1CC";
            ctx.font = "60px Arial";
            if (perfectClear < 7){ // decrease hitbox size
                perfectClear++;
                ctx.fillText("Hitbox size decreased!", (x / 2 - 325), (y / 2 - 75));
                ctx.fillText("ヒットボックスを減らす!", (x / 2 - 325), (y / 2 + 50));       
            }
            for (count = 0; count < 3; count++){
                ctx.fillText("+ Perfect 完全 +", (x / 2 - 200)+count, (y / 2 - 175)+count);
            }  
            ctx.fillRect(0,40, window.innerWidth, 20);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
            wait(3000);
        } else { // normal clear
            ctx.fillText("Enemies Approaching", x / 2 - 300, y / 2 - 175);
            ctx.fillText("非常に大きな敵に接近する危険!", x / 2 - 425, y / 2 - 50);
            ctx.fillText("慎重に進んでください!", x / 2 - 300, y / 2 + 25);
            wait(3000);
        }
    } else { // you lose
        deaths += 1; 
        aud_death.volume = 0.1;
        aud_death.play();
        ctx.fillText("Score: " + score, x / 2 - 200, y / 2 - 75);
        switch (deathSlogan) { // slogans
            case 69:deathSlogan = "😂";break;
            case 666:deathSlogan = "😈";break;
            case 420:deathSlogan = "blaze it";break;
            case 911:deathSlogan = "TOO SOON";break;
            case 999:deathSlogan = "TOO HARD";break;
            default: deathSlogan = "";break;
        }
        ctx.fillText(deathSlogan, x / 2 -100, y / 2 +25);  
        if (score >= 900) {
            ctx.fillText("So Close", x / 2 - 200, y / 2 - 175);
        } else if (score <= 100) {
            ctx.fillText("...", x / 2 - 100, y / 2 - 175);
        } else {
            ctx.fillStyle = "red";
            ctx.fillText("Try Again", x / 2 - 200, y / 2 - 175);
            ctx.fillText("再試行する", x / 2 - 200, y / 2 +25);   
        }
        wait(2000);
    }
    score = 0;
}

function resumeSpeed() {
    focused = false;
    if (alive) {
        gamePiece.width = 20 - perfectClear;
        gamePiece.height = 20 - perfectClear;
    }
    speed = 1;
    setAudioSpeed(1);
}

function setSlowSpeed(){
    focused = true;
    gamePiece.width = 15 - perfectClear;
    gamePiece.height = 15 - perfectClear;
    speed = 0.3;
    setAudioSpeed(0.75);
}

function setFastSpeed(){
    focused = true;
    gamePiece.width = 15 - perfectClear;
    gamePiece.height = 15 - perfectClear;
    speed = 2;
    setAudioSpeed(1.2);
}

function setBreak(scorePenalty){
    if (!invincible) {
        myObstaclesPowerup = []; // destroy powerups on break
        myObstaclesPowerupGold = [];
        invincible = true;
        score += -scorePenalty;
        setAudioSpeed(1.0);
    }
}

function checkBounds(e,x1,x2,y1,y2){
    // check if mouse click is within x/y coords
    var mouseX = e.clientX - 8;
    var mouseY = e.clientY - 8;
    if (mouseX > (x / 2) - x1 && mouseX < (x / 2) + x2 && mouseY > (y / 2) - y1 && mouseY < (y / 2) + y2) {
        return true;
    }
}

var gameArea = {
    canvas: document.createElement("canvas"),
    load: function () {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        window.addEventListener('click', function (e) {
            if (gameStart == false && checkBounds(e,410,-190,32,14)) { // CLICK TO START
                startGame(e);
            } else if (gameStart == false && checkBounds(e,0,272,0,40)) { // SPACE TO BREAK
                alert("SPACEBAR or MIDDLE MOUSE BUTTON = BREAK - Become invincible briefly.  Lose score, emergency use only!");
            } else if (gameStart == false && checkBounds(e,0,272,60,100)) { // SHIFT TO FOCUS
                alert("SHIFT or LEFT MOUSE BUTTON = FOCUS - Slows time and decrease hitbox size.  Earn no score, use in a tight spot.");
            } else if (gameStart == false && checkBounds(e,0,272,120,160)) { // CLICK TO WARP
                alert("CTRL or RIGHT MOUSE BUTTON: WARP - Speeds up time.  Earn double score, you madman.");
            }
        })
        window.addEventListener('mousedown', function (e) {
            e.preventDefault();
             if (alive) {
                if (e.which == 3) { // right mouse button. keyCode = 3
                    setFastSpeed();
                }
                if (e.which == 1) { // left mouse button. keyCode = 1
                    setSlowSpeed();
                }
                if (e.which == 2) { // middle mouse button. keyCode = 2
                    if (alive) {
                        setBreak(scorePenalty);
                    }
                }
            }
        })
        window.addEventListener('mouseup', function (e) {
            e.preventDefault;
            if (e.which == 3 || e.which == 1) { // resume speed if LMB or RMB is released
                resumeSpeed();
            }
        })
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            if (e.which == 80 || e.keyCode == 80) { // P. keyCode = 112
                if (pause){
                    pause = false;
                } else {
                    pause = true;
                }
            }
            if (e.which == 32 || e.keyCode == 32) { // SPACEBAR. keyCode = 32
                if (alive) {
                    setBreak(scorePenalty);
                }
            }
            if (e.shiftKey) { // SHIFT. keyCode = 16
                if (alive) {
                    setSlowSpeed();
                }
            }
            if (e.ctrlKey) { // CTRL. keyCode = 17
                if (alive) {
                    setFastSpeed();
                }
            }
        })
        window.addEventListener('keyup', function (e) { // resume speed if CTRL or SHIFT key is released
            if (e.which == 16 || e.keyCode == 16 || e.which == 17 || e.keyCode == 17) {
                resumeSpeed();
            } 
        })
    },
    start: function () {
        this.canvas.style.cursor = "none"; // hide the original cursor
        this.context = this.canvas.getContext("2d");
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('mousemove', function (e) {
            gameArea.x = e.pageX;
            gameArea.y = e.pageY;
            if (invincible) {
                gamePiece.height = 20 - perfectClear;
                gamePiece.width = 20 - perfectClear;
            } else {
                if (focused){
                    gamePiece.height = 15 - perfectClear;
                    gamePiece.width = 15 - perfectClear;
                } else {
                    gamePiece.height = 20 - perfectClear;
                    gamePiece.width = 20 - perfectClear;
                    gamePiece = new component(20 - perfectClear, 20 - perfectClear, gamePieceColor, e.pageX, e.pageY);
                }
            }
        })
    },
    clear: function () {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },
    stop: function () {
        clearInterval(this.interval);
    }
}

function component(width, height, color, x, y) {
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;
    this.x = x;
    this.y = y;
    this.update = function () {
        ctx = gameArea.context;
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
    }

    this.crashWith = function (otherobj) {
        var myleft = this.x;
        var myright = this.x + (this.width);
        var mytop = this.y;
        var mybottom = this.y + (this.height);
        var otherleft = otherobj.x;
        var otherright = otherobj.x + (otherobj.width);
        var othertop = otherobj.y;
        var otherbottom = otherobj.y + (otherobj.height);
        var crash = true;
        if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
            crash = false;
        }
        return crash;
    }
}

function detectCollision(objects) { // detect collision between gamePiece and object group
    for (i = 0; i < objects.length; i += 1) {
        if (gamePiece.crashWith(objects[i])) { // collision
            return true;
        }
    }
}

function moveObstacles(objects, ammount) {
    for (i = 0; i < objects.length; i += 1) {
        objects[i].x += -ammount * speed; // speed of obstacles
        objects[i].update();
    }
}

function updateGameArea() {
    if (!pause){
        var x, height, gap, minHeight, maxHeight, minGap, maxGap;
        if (!invincible) { // detect collisions
            if (detectCollision(myObstacles1) || detectCollision(myObstacles2) || detectCollision(myObstacles3) || detectCollision(myObstacles4)) {
                gameOver();
                return;
            }
        }

        if (detectCollision(myObstaclesPowerup)) { // powerup collision
            myObstaclesPowerup = [];
            setBreak(0);
        }

        if (detectCollision(myObstaclesPowerupGold)) { // powerup collision
            myObstaclesPowerupGold = [];
            score += 150;
        }

        gameArea.clear();
        gameArea.frameNo += 1;
        if (invincible) {
            ctx.fillRect(gamePiece.x -50 + invincibleTime, gamePiece.y - 25, (75 - invincibleTime)*2, (7*2)); // display invincible progress
            invincibleTime += 1;
            if (focused) {
                gamePiece = new component(15 - perfectClear, 15 - perfectClear, getRandomColor(), gamePiece.pageX, gamePiece.pageY);
            } else {
                gamePiece = new component(20 - perfectClear, 20 - perfectClear, getRandomColor(), gamePiece.pageX, gamePiece.pageY);
            }
            
            ctx.fillRect(gamePiece.x -50 + invincibleTime, gamePiece.y - 25, (75 - invincibleTime)*2, (7*2)); // display invincible progress
            if (invincibleTime >= 75) {
                if (focused) {
                    gamePiece = new component(15 - perfectClear, 15 - perfectClear, gamePieceColor, gamePiece.pageX, gamePiece.pageY);
                } else {
                    gamePiece = new component(20 - perfectClear, 20 - perfectClear, gamePieceColor, gamePiece.pageX, gamePiece.pageY);
                }
                invincible = false;
                invincibleTime = 0;
                setAudioSpeed(1.0);
            }
        }

        ctx.fillStyle = "black";
        ctx.font = "40px Arial";

        switch (level) { // level names
            case 1:
                ctx.fillText("Breath Easy", 80, window.innerHeight - 60);
                    break;
            case 2:
                ctx.fillText("Clear Your Mind", 80, window.innerHeight - 60);
                    break;
            case 3:
                ctx.fillText("Looking Inward", 80, window.innerHeight - 60);
                    break;
            case 4:
                ctx.fillText("Flow", 80, window.innerHeight - 60);
                    break;
            case 5:
                ctx.fillText("Reaching", 80, window.innerHeight - 60);
                    break;
            case 6:
                if (deaths == 0){
                    ctx.fillText("Seeking Perfection", 80, window.innerHeight - 60);
                } else {
                    ctx.fillText("Past mistakes", 80, window.innerHeight - 60);
                }
                    break;
            case 7:
                ctx.fillText("Looking Outward", 80, window.innerHeight - 60);
                    break;
            case 8:
                ctx.fillText("Memory Advance", 80, window.innerHeight - 60);
                    break;
            case 9:
                ctx.fillText("Self Destruct", 80, window.innerHeight - 60);
                    break;
            case 10:
                if (deaths == 0){
                    ctx.fillText("Perfection", 80, window.innerHeight - 60);
                } else {
                    ctx.fillText("Remains", 80, window.innerHeight - 60);
                }
                    break;
            case 11:
                ctx.fillText("Afterlife", 80, window.innerHeight - 60);
                    break;
            case 12:
                ctx.fillText("Desolation", 80, window.innerHeight - 60);
                    break;
            case 13:
                ctx.fillStyle = "red";
                ctx.fillRect(900, 0, 100, window.innerHeight);
                ctx.fillStyle = "black";
                ctx.fillText("Rebirth", 80, window.innerHeight - 60);
                    break;
            case 14:
                ctx.fillRect(900, 0, 100, window.innerHeight);
                ctx.fillRect(1100, 0, 2000, window.innerHeight);
                ctx.fillText("...", 80, window.innerHeight - 60);
                    break;
            default:
                ctx.fillText("How did this happen?", 80, window.innerHeight - 60);
                    break;
            }
        // Object Spawning
        if (level >= 1) { // level 1 vertical black bars
            if (gameArea.frameNo == 1 || everyinterval(25 / (speed +2))) { // distance vertical bars
                v_x = gameArea.canvas.width;
                minHeight = 20;
                maxHeight = window.innerHeight - 60;
                height = Math.floor(Math.random() * (maxHeight - minHeight + 1) + minHeight);
                minGap = 85-(level*2);
                maxGap = 125-(level*2);
                gap = Math.floor(Math.random() * (maxGap - minGap + 1) + minGap);
                myObstacles1.push(new component(20, height, "black", v_x, 0));
                myObstacles1.push(new component(20, v_x - height - gap, "black", v_x, height + gap));
            }
            if (everyinterval(125)) { // powerup
                if (!focused){
                    if (~~(Math.random()*2) ? true : false) { // break powerup
                        myObstaclesPowerup.push(new component(15, 15, getRandomColor, document.body.clientWidth, Math.random() * window.innerHeight));
                    } else { // score powerup
                        myObstaclesPowerupGold.push(new component(20, 20, getRandomGoldColorHex(), document.body.clientWidth, Math.random() * window.innerHeight));
                    }   
                }   
            }
        }
        if (level >= 2) { // level 2 black slow moving large
            if (gameArea.frameNo == 1 || everyinterval(50 / speed)) {
                myObstacles3.push(new component(window.innerHeight / 8, window.innerHeight / 8, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 3) { // level 3 black medium
            if (gameArea.frameNo == 1 || everyinterval((10 - level) / speed)) {
                myObstacles2.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 4) { // level 4 red small
            if (gameArea.frameNo == 1 || everyinterval(10 / speed)) {
                myObstacles1.push(new component(10, 10, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 5) { // level 5 black medium
            if (gameArea.frameNo == 1 || everyinterval((10 - level) / speed)){
                myObstacles2.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight))
            }
        }
        if (level >= 9){ // level 9 red mediun
            if (gameArea.frameNo == 1 || everyinterval((25 - level) / speed)){
                myObstacles2.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));  
            }
        }
        if (level == 10){
            if (gameArea.frameNo == 1 || everyinterval((1) / speed)){
                myObstacles2.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));  
            }
        }
        if (level >= 10){ // level 10 red big
            if (gameArea.frameNo == 1 || everyinterval(100 / speed)) {
                myObstacles4.push(new component(window.innerHeight / 4, window.innerHeight / 4, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 12) { // level 12 black oblong
            if (gameArea.frameNo == 1 || everyinterval(10 / speed)) {
                myObstacles1.push(new component(10, 50, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 13) { // level 13 red medium
            if (gameArea.frameNo == 1 || everyinterval((10 - level) / speed)) {
                myObstacles2.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }
        if (level >= 14){ // level 14 red big, black medium
            if (gameArea.frameNo == 1 || everyinterval(75 / speed)) {
                myObstacles4.push(new component(window.innerHeight / 8, window.innerHeight / 8, "red", document.body.clientWidth, Math.random() * window.innerHeight));
            } 
            if (gameArea.frameNo == 1 || everyinterval((10 - level) / speed)){
                myObstacles2.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight));
            }
        }    
        if (level >= 15) { // level 15 red and black medium
            if (gameArea.frameNo == 1 || everyinterval((10) / speed)) {
                myObstacles2.push(new component(25, 25, "red", document.body.clientWidth, Math.random() * window.innerHeight));
                myObstacles2.push(new component(25, 25, "black", document.body.clientWidth, Math.random() * window.innerHeight));
                setFastSpeed();
            }
        }
        for (i = 0; i < myObstaclesPowerup.length; i += 1) { // move powerups 
            myObstaclesPowerup[i].x += -4 * speed;
            obj_x = myObstaclesPowerup[i].x;
            obj_y = myObstaclesPowerup[i].y;
            myObstaclesPowerup = [];
            myObstaclesPowerup.push(new component(15, 15, getRandomColor(), obj_x, obj_y));
            myObstaclesPowerup[i].update();
        }
        for (i = 0; i < myObstaclesPowerupGold.length; i += 1) { // move powerupsgold
            myObstaclesPowerupGold[i].x += -4 * speed;
            obj_x = myObstaclesPowerupGold[i].x;
            obj_y = myObstaclesPowerupGold[i].y;
            myObstaclesPowerupGold = [];
            myObstaclesPowerupGold.push(new component(20, 20, getRandomGoldColorHex(), obj_x, obj_y));
            myObstaclesPowerupGold[i].update();
        }
        
        moveObstacles(myObstacles1, 4);
        moveObstacles(myObstacles2, 8);
        moveObstacles(myObstacles3, 10);
        moveObstacles(myObstacles4, 2);
        
        if (gameArea.x && gameArea.y) {
            gamePiece.x = gameArea.x;
            gamePiece.y = gameArea.y;
        }
        if (invincible) { // BREAK
            ctx.fillStyle = getRandomColor();
            ctx.globalAlpha = 0.75;
            ctx.font = "60px Arial";
            if (everyinterval(0.5)) {
                ctx.fillText("BREAK! 壊れる", 200, 200);
            }
            ctx.fillRect(0,40, window.innerWidth, 20);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 20);
            ctx.font = "40px Arial";
            ctx.globalAlpha = 0.8;
            ctx.fillText(deaths, 50, 200); // show deaths
            ctx.fillText("Level " + level, 50, 300); // show level
            ctx.fillStyle = "red"; // color
            ctx.fillText(score, 50, 100);
            ctx.globalAlpha = 1.0;
        } else {
            ctx.fillStyle = "black"; // color
            ctx.fillText(score, 50, 100); // show score
            ctx.fillText(deaths, 50, 200); // show deaths
            ctx.fillText("Level " + level, 50, 300); // show level
        } if (speed == 1) {
            score++;
        } else if (speed == 0.3) { // FOCUS
            ctx.globalAlpha = 0.75;
            ctx.fillRect(0,40, window.innerWidth, 30);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 30);
            ctx.fillStyle = "red";
            ctx.font = "60px Arial";
            ctx.fillText("FOCUS! 焦点", 200, 200);
            ctx.font = "40px Arial";
            ctx.fillText(score, 50, 100);
            ctx.globalAlpha = 1.0;
        } else if (speed == 2 ){
            aud_danger.volume = 0.1;
            aud_danger.play();
            ctx.fillStyle = "red";
            ctx.globalAlpha = 0.8;
            ctx.fillRect(0,40, window.innerWidth, 30);
            ctx.fillRect(0,window.innerHeight - 60, window.innerWidth, 30);
            ctx.globalAlpha = 1.0;
            ctx.font = "60px Arial";
            if (everyinterval(1)) {
                ctx.fillText("DANGER! 危険", 200, 200);
            }
            ctx.font = "40px Arial";
            ctx.fillStyle = getRandomColor();
            ctx.fillText("+", 120, 100);
            ctx.fillText(score, 50, 100);
            score += 3;
        }
        gamePiece.update();
        if (score >= scoreLimit) { // score limit reached
            if (level == 9){ // play until you die
                ctx.fillStyle = getRandomColor();
                ctx.fillText(score, 50, 100);
            } else {
                gameOver();
            }
        }
    }  else {  // pause
        ctx.fillStyle = "red";
        ctx.fillText("PAUSED", 156, 156);
    } 

}

function everyinterval(n) {
    if ((((gameArea.frameNo) / (n)) % 2) == 0) { return true; }
    return false;
}

function unloadScrollBars() {
    document.documentElement.style.overflow = 'hidden';  // firefox, chrome
    document.body.scroll = "no"; // ie only
}

function getRandomColor() {  // generate a random color
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

function getRandomGoldColorHex() {
  // Define the range of shades for gold color
  var minHue = 25; // Minimum hue value for gold color in degrees (corresponds to yellow)
  var maxHue = 100; // Maximum hue value for gold color in degrees
  var saturation = 100; // Saturation value for gold color
  var lightness = 50; // Lightness value for gold color

  // Generate a random hue within the specified range
  var hue = Math.floor(Math.random() * (maxHue - minHue + 1)) + minHue;

  // Convert the HSL color to RGB
  var hslToRgb = function (h, s, l) {
    h /= 360;
    s /= 100;
    l /= 100;
    var r, g, b;

    if (s === 0) {
      r = g = b = l;
    } else {
      var hueToRgb = function (p, q, t) {
        if (t < 0) t += 1;
        if (t > 1) t -= 1;
        if (t < 1 / 6) return p + (q - p) * 6 * t;
        if (t < 1 / 2) return q;
        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
        return p;
      };

      var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      var p = 2 * l - q;

      r = hueToRgb(p, q, h + 1 / 3);
      g = hueToRgb(p, q, h);
      b = hueToRgb(p, q, h - 1 / 3);
    }

    return {
      r: Math.round(r * 255),
      g: Math.round(g * 255),
      b: Math.round(b * 255),
    };
  };

  // Convert HSL to RGB
  var color = hslToRgb(hue, saturation, lightness);

  // Convert RGB to hex notation
  var rgbToHex = function (r, g, b) {
    var componentToHex = function (component) {
      var hex = component.toString(16);
      return hex.length === 1 ? "0" + hex : hex;
    };

    return (
      "#" +
      componentToHex(r) +
      componentToHex(g) +
      componentToHex(b)
    );
  };

  // Return the hex color as a string
  return rgbToHex(color.r, color.g, color.b);
}

function millisToMinutesAndSeconds(millis) { // ms conversions
  var minutes = Math.floor(millis / 60000);
  var seconds = ((millis % 60000) / 1000).toFixed(0);
  return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
}

</script>
</body>
</html>